<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC Reader with Persistent Logs</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 1em; }
    table { width: 100%; margin-top: 1em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5em; font-size: 0.9em; }
    th { background-color: #f0f0f0; }
    button { margin: 0.5em 0.5em 0.5em 0; padding: 0.5em 1em; }
  </style>
</head>
<body>

  <h2>üì± NFC Tag Reader</h2>
  <p>Tap an NFC tag to read its content. If it's a URL, it will load below.</p>
  <button onclick="startScan()">Start NFC Scan</button>
  <button onclick="downloadCSV()">Download Log as CSV</button>
  <button onclick="clearLogs()">Clear Log</button>

  <iframe id="iframe" src="about:blank"></iframe>

  <h3>üìù Scan Log</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Content</th>
      </tr>
    </thead>
    <tbody id="logTable"></tbody>
  </table>

  <script>
    const logTable = document.getElementById("logTable");
    const iframe = document.getElementById("iframe");
    let logs = [];

    // Load logs from localStorage on page load
    window.onload = () => {
      const stored = localStorage.getItem("nfcLogs");
      if (stored) {
        logs = JSON.parse(stored);
        logs.forEach(log => updateLogTable(log.time, log.text));
      }
    };

    async function startScan() {
      if (!("NDEFReader" in window)) {
        alert("Web NFC is not supported in this browser.");
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        console.log("NFC scan started");

        ndef.onreading = event => {
          const decoder = new TextDecoder();
          const time = new Date().toLocaleString();

          for (const record of event.message.records) {
            let text = decoder.decode(record.data);
            if (!text && record.recordType === "url") {
              text = record.data;
            }

            const log = { time, text };
            logs.push(log);
            updateLogTable(time, text);
            saveLogs();

            if (isValidURL(text)) {
              iframe.src = text;
            }
          }
        };
      } catch (error) {
        console.error("NFC Scan error:", error);
        alert("Failed to start NFC scan. Ensure you're on Android with NFC enabled.");
      }
    }

    function updateLogTable(time, content) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${time}</td><td>${content}</td>`;
      logTable.prepend(row);
    }

    function saveLogs() {
      localStorage.setItem("nfcLogs", JSON.stringify(logs));
    }

    function downloadCSV() {
      if (logs.length === 0) {
        alert("No logs to download.");
        return;
      }

      const headers = "Time,Content\n";
      const rows = logs.map(log => `"${log.time}","${log.text.replace(/"/g, '""')}"`).join("\n");
      const csvContent = headers + rows;

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "nfc_scan_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearLogs() {
      if (confirm("Are you sure you want to clear all scan logs?")) {
        logs = [];
        localStorage.removeItem("nfcLogs");
        logTable.innerHTML = "";
        iframe.src = "about:blank";
      }
    }

    function isValidURL(str) {
      try {
        const url = new URL(str);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch (_) {
        return false;
      }
    }
  </script>

</body>
</html>
