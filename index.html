<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC & QR Image Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 700px; margin: auto; }
    img { max-width: 100%; margin-top: 1em; display: none; border: 1px solid #ccc; padding: 4px; }
    table { width: 100%; margin-top: 1.5em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5em; font-size: 0.9em; word-break: break-word; }
    th { background-color: #f0f0f0; }
    button {
      margin: 0.5em 0.5em 0.5em 0;
      padding: 0.8em 1.5em;
      font-size: 1em;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
    }
    #qr-reader {
      width: 100%;
      margin-top: 1em;
      display: none;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.j"></script>
</head>
<body>

  <h2>üì± JW convention security check</h2>
  <p>Tap ID card or scan QR code</p>

  <button onclick="startScan()">Start NFC Scan</button>
  <button onclick="startQRScan()">Start QR Scan</button>
  <button onclick="downloadCSV()">Download Log as CSV</button>
  <button onclick="clearLogs()">Clear Log</button>

  <div id="qr-reader"></div>
  <img id="previewImage" src="" alt="Scanned image will appear here" />

  <h3>üìù Scan Log</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Content</th>
      </tr>
    </thead>
    <tbody id="logTable"></tbody>
  </table>

  <script>
    const logTable = document.getElementById("logTable");
    const img = document.getElementById("previewImage");
    const qrReader = document.getElementById("qr-reader");
    let logs = [];

    window.onload = () => {
      const stored = localStorage.getItem("nfcLogs");
      if (stored) {
        logs = JSON.parse(stored);
        logs.forEach(log => updateLogTable(log.time, log.text));
      }
    };

    async function startScan() {
      if (!("NDEFReader" in window)) {
        alert("Web NFC is not supported in this browser.");
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        console.log("NFC scan started");

        ndef.onreading = event => {
          const decoder = new TextDecoder();
          const time = new Date().toLocaleString();

          for (const record of event.message.records) {
            let text = decoder.decode(record.data).trim();
            handleScannedContent(text, time);
          }
        };
      } catch (error) {
        console.error("NFC Scan error:", error);
        alert("Failed to start NFC scan. Make sure you're on Android with NFC enabled and using Chrome.");
      }
    }

    function startQRScan() {
      qrReader.style.display = "block";
      const html5QrCode = new Html5Qrcode("qr-reader");

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const rearCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];

          html5QrCode.start(
            rearCamera.id,
            { fps: 10, qrbox: 250 },
            text => {
              const time = new Date().toLocaleString();
              handleScannedContent(text, time);
              html5QrCode.stop().then(() => {
                qrReader.style.display = "none";
              });
            },
            error => {}
          );
        } else {
          alert("No camera found.");
        }
      }).catch(err => {
        console.error("Camera error:", err);
        alert("Unable to access camera for QR scanning.");
      });
    }

    function handleScannedContent(text, time) {
      let embedUrl = text;

      const gdriveMatch = text.match(/https:\/\/drive\.google\.com\/file\/d\/([^\/]+)\/view/);
      if (gdriveMatch) {
        const fileId = gdriveMatch[1];
        embedUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
      }

      logs.push({ time, text });
      updateLogTable(time, text);
      saveLogs();

      img.src = embedUrl;
      img.style.display = "block";
    }

    function updateLogTable(time, content) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${time}</td><td>${content}</td>`;
      logTable.prepend(row);
    }

    function saveLogs() {
      localStorage.setItem("nfcLogs", JSON.stringify(logs));
    }

    function downloadCSV() {
      if (logs.length === 0) {
        alert("No logs to download.");
        return;
      }

      const headers = "Time,Content\n";
      const rows = logs.map(log => `"${log.time}","${log.text.replace(/"/g, '""')}"`).join("\n");
      const csvContent = headers + rows;

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "nfc_qr_scan_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearLogs() {
      if (confirm("Are you sure you want to clear all scan logs?")) {
        logs = [];
        localStorage.removeItem("nfcLogs");
        logTable.innerHTML = "";
        img.src = "";
        img.style.display = "none";
      }
    }
  </script>

</body>
</html>
